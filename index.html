<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Undyne-style Shield Game</title>
<style>
  :root{--bg:#000;--fg:#fff}
  html,body{height:100%;margin:0;background:#111;color:var(--fg);font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .wrap{display:flex;align-items:center;justify-content:center;height:100vh}
  #game{background:#000;border:6px solid #fff;display:block}
  .ui{position:absolute;left:20px;top:20px;color:#fff;font-weight:700}
  .center-ui{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center}
  #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:auto}
  button{background:#fff;color:#000;border:none;padding:12px 18px;border-radius:8px;font-weight:700;cursor:pointer}
  #gameover{font-size:64px;letter-spacing:4px}
  #hud{position:absolute;right:20px;top:20px;color:#fff;font-weight:700;text-align:right}
</style>
</head>
<body>
<div class="wrap">
  <div style="position:relative;">
    <canvas id="game" width="800" height="600"></canvas>

    <div class="ui" id="scoreUI">Score: 0<br>High: 0</div>

    <div id="overlay">
      <div class="center-ui">
        <h1 style="margin:0 0 12px 0;color:#fff">Undyne-style Shield Demo</h1>
        <button id="startBtn">Click to Start</button>
        <div style="margin-top:10px;color:#ddd;font-size:13px">Use arrow keys to snap the shield around the SOUL</div>
      </div>
    </div>
  </div>
</div>

<script>
const ASSETS = {
  soul: 'assets/SOUL.png',
  shield: 'assets/shield.png',
  arrow: 'assets/arrow.png',
  music: 'assets/music.mp3'
};

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

const overlay = document.getElementById('overlay');
const startBtn = document.getElementById('startBtn');
const scoreUI = document.getElementById('scoreUI');

const imgSoul = new Image(); imgSoul.src = ASSETS.soul;
const imgShield = new Image(); imgShield.src = ASSETS.shield;
const imgArrow = new Image(); imgArrow.src = ASSETS.arrow;

const music = new Audio(ASSETS.music);
music.loop = true;

let running = false;
let arrows = [];
let lastTime = 0;
let waveTimer = 0;
let waveInterval = 1200;
let waveCount = 0;
let baseSpeed = 200;
let speedIncrement = 25;
let score = 0;
let highScore = parseInt(localStorage.getItem('ud_high')||'0',10) || 0;
scoreUI.innerHTML = `Score: ${score}<br>High: ${highScore}`;

const player = { x: W/2, y: H/2, r: 18, alive: true };

let shield = {
  radius: 60,
  width: 12,
  height: 90,
  angle: 0,
};

// Snap shield positions (up,right,down,left)
const snapAngles = {
  ArrowUp: -Math.PI/2,
  ArrowRight: 0,
  ArrowDown: Math.PI/2,
  ArrowLeft: Math.PI
};

window.addEventListener('keydown', e=>{
  if(snapAngles[e.key]!==undefined){
    shield.angle = snapAngles[e.key];
    e.preventDefault();
  }
});

function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function spawnArrow(direction){
  let ax, ay, vx, vy;
  const speed = baseSpeed + waveCount * speedIncrement;
  if(direction==='left'){
    ax = 0; ay = H/2; vx = speed; vy = 0;
  } else if(direction==='right'){
    ax = W; ay = H/2; vx = -speed; vy = 0;
  } else if(direction==='top'){
    ax = W/2; ay = 0; vx = 0; vy = speed;
  } else {
    ax = W/2; ay = H; vx = 0; vy = -speed;
  }
  arrows.push({x:ax,y:ay,vx,vy,dir:direction});
}

function spawnWave(){
  waveCount++;
  const dirs = ['top','bottom','left','right'];
  // Shuffle directions
  for(let i=dirs.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [dirs[i],dirs[j]] = [dirs[j],dirs[i]];
  }
  dirs.forEach((d,i)=>{
    setTimeout(()=>spawnArrow(d), i*250);
  });
}

function pointIntersectsShield(px,py){
  const sx = player.x + Math.cos(shield.angle) * shield.radius;
  const sy = player.y + Math.sin(shield.angle) * shield.radius;
  const rx = px - sx;
  const ry = py - sy;
  const ca = Math.cos(-shield.angle);
  const sa = Math.sin(-shield.angle);
  const lx = rx * ca - ry * sa;
  const ly = rx * sa + ry * ca;
  const hw = shield.width/2 + 4;
  const hh = shield.height/2 + 4;
  return (lx >= -hw && lx <= hw && ly >= -hh && ly <= hh);
}

function update(dt){
  if(!running) return;

  for(let i=arrows.length-1;i>=0;i--){
    const a = arrows[i];
    a.x += a.vx * dt;
    a.y += a.vy * dt;

    if(pointIntersectsShield(a.x,a.y)){
      arrows.splice(i,1);
      score += 1;
      if(score>highScore){ highScore = score; localStorage.setItem('ud_high', highScore); }
      scoreUI.innerHTML = `Score: ${score}<br>High: ${highScore}`;
      continue;
    }

    const dx = a.x - player.x;
    const dy = a.y - player.y;
    if(dx*dx + dy*dy <= player.r*player.r){
      player.alive = false;
      running = false;
      gameOver();
      return;
    }
  }

  waveTimer += dt*1000;
  if(waveTimer >= waveInterval){ waveTimer = 0; spawnWave(); }
}

function draw(){
  ctx.clearRect(0,0,W,H);

  if(player.alive){
    if(imgSoul.complete && imgSoul.naturalWidth){
      const s = 48;
      ctx.drawImage(imgSoul, player.x - s/2, player.y - s/2, s, s);
    } else {
      ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill();
    }
  }

  const sx = player.x + Math.cos(shield.angle) * shield.radius;
  const sy = player.y + Math.sin(shield.angle) * shield.radius;
  ctx.save();
  ctx.translate(sx,sy);
  ctx.rotate(shield.angle);
  if(imgShield.complete && imgShield.naturalWidth){
    ctx.drawImage(imgShield, -shield.width/2, -shield.height/2, shield.width, shield.height);
  } else {
    ctx.fillStyle = '#00f9ff'; ctx.fillRect(-shield.width/2, -shield.height/2, shield.width, shield.height);
  }
  ctx.restore();

  for(const a of arrows){
    ctx.save();
    ctx.translate(a.x,a.y);
    const angle = Math.atan2(a.vy, a.vx) + Math.PI/2;
    ctx.rotate(angle);
    if(imgArrow.complete && imgArrow.naturalWidth){
      const s = 28;
      ctx.drawImage(imgArrow, -s/2, -s/2, s, s);
    } else {
      ctx.fillStyle = '#ff0044'; ctx.beginPath(); ctx.moveTo(0,-12); ctx.lineTo(8,8); ctx.lineTo(-8,8); ctx.closePath(); ctx.fill();
    }
    ctx.restore();
  }
}

function loop(ts){
  if(!lastTime) lastTime = ts;
  const dt = Math.min(0.05, (ts - lastTime)/1000);
  lastTime = ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

function resetGame(){
  arrows = [];
  waveCount = 0;
  waveTimer = 0;
  score = 0;
  player.alive = true;
  shield.angle = 0;
  scoreUI.innerHTML = `Score: ${score}<br>High: ${highScore}`;
}

function gameOver(){
  overlay.style.pointerEvents = 'auto';
  overlay.innerHTML = `<div class="center-ui"><div id=\"gameover\">GAME OVER</div><div style=\"margin-top:12px;color:#ddd\">Score: ${score} &nbsp;&nbsp; High: ${highScore}</div></div>`;
  try{ music.pause(); music.currentTime = 0; } catch(e){}
  setTimeout(()=>{
    overlay.innerHTML = `<div class=\"center-ui\"><h1 style=\"margin:0 0 12px 0;color:#fff\">Undyne-style Shield Demo</h1><button id=\"startBtn\">Click to Start</button><div style=\"margin-top:10px;color:#ddd;font-size:13px\">Use arrow keys to snap the shield around the SOUL</div></div>`;
    const sb = document.getElementById('startBtn');
    if(sb) sb.addEventListener('click', startGame);
    resetGame();
  }, 1800);
}

function startGame(){
  music.play().catch(()=>{});
  overlay.style.pointerEvents = 'none';
  overlay.innerHTML = '';
  running = true;
  lastTime = 0;
  waveTimer = 0;
  baseSpeed = 200;
  spawnWave();
}

startBtn.addEventListener('click', startGame);
requestAnimationFrame(loop);
</script>
</body>
</html>
